<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembayaran Modern</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Keyframes untuk Animasi Masuk (fade-in) */
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Keyframes untuk Animasi Muncul (fade-up) */
        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Keyframes untuk Animasi Keluar (fade-out) */
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* Kelas untuk menerapkan animasi */
        .animate-slide-in-down {
            animation: slideInDown 0.5s ease-out forwards;
        }
        .animate-fade-up {
            animation: fadeUp 0.6s ease-out forwards;
            opacity: 0; /* Mulai dari tidak terlihat */
        }
        .animate-fade-out {
            animation: fadeOut 0.5s ease-in forwards;
        }

        /* Styling tambahan untuk modal, agar transisinya halus */
        .modal-active {
            opacity: 1 !important;
            transform: scale(1) !important;
            pointer-events: auto !important;
        }
        /* Styling untuk font Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen py-8 text-gray-800">
    <!-- Kontainer utama aplikasi -->
    <div class="container mx-auto max-w-5xl px-4">
        <!-- Bagian judul aplikasi -->
        <div class="text-center mb-8 animate-fade-up" style="animation-delay: 100ms;">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2 tracking-tight">Sistem Pembayaran Modern</h1>
            <p class="text-gray-600">Kelola transaksi dengan antarmuka yang lebih baik</p>
        </div>

        <!-- Grid layout untuk formulir dan riwayat transaksi -->
        <div class="grid lg:grid-cols-5 gap-8">
            <!-- Form Pembayaran -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6 animate-fade-up" style="animation-delay: 200ms;">
                <div class="flex items-center mb-6">
                    <!-- Icon Kartu Kredit (Lucide-react equivalent) -->
                    <svg class="w-6 h-6 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                    <h2 class="text-xl font-semibold text-gray-800">Form Pembayaran</h2>
                </div>

                <form id="paymentForm" class="space-y-4">
                    <input type="text" id="customerName" name="customerName" placeholder="Nama Pelanggan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                    <input type="email" id="customerEmail" name="customerEmail" placeholder="Email Pelanggan" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                    <select id="productSelect" name="product" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                        <option value="">Pilih produk...</option>
                        <option value="basic" data-price="50000">Paket Basic - Rp 50.000</option>
                        <option value="premium" data-price="100000">Paket Premium - Rp 100.000</option>
                        <option value="professional" data-price="200000">Paket Professional - Rp 200.000</option>
                        <option value="enterprise" data-price="500000">Paket Enterprise - Rp 500.000</option>
                    </select>
                    <input type="number" id="quantity" name="quantity" min="1" value="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Metode Pembayaran</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 transition">
                                <input type="radio" name="paymentMethod" value="transfer" class="text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm">Transfer Bank</span>
                            </label>
                            <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 transition">
                                <input type="radio" name="paymentMethod" value="ewallet" class="text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm">E-Wallet</span>
                            </label>
                            <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 transition">
                                <input type="radio" name="paymentMethod" value="credit" class="text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm">Kartu Kredit</span>
                            </label>
                            <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 transition">
                                <input type="radio" name="paymentMethod" value="cash" class="text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm">Bayar Tunai</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label for="promoCode" class="block text-sm font-medium text-gray-700 mb-2">Kode Promo</label>
                        <div class="flex gap-2">
                            <input type="text" id="promoCode" name="promoCode" placeholder="Masukkan kode promo" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                            <button type="button" id="applyPromoBtn" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">Terapkan</button>
                        </div>
                    </div>

                    <!-- Ringkasan pembayaran -->
                    <div class="bg-gray-50 rounded-lg p-4 mt-4 space-y-2">
                        <div class="flex justify-between items-center text-sm text-gray-600">
                            <span>Subtotal</span>
                            <span id="subtotal">Rp 0</span>
                        </div>
                        <div id="discountRow" class="flex justify-between items-center text-sm text-green-600 hidden">
                            <span>Diskon</span>
                            <span id="discount">Rp 0</span>
                        </div>
                        <div class="flex justify-between items-center text-xl font-bold text-gray-800 border-t pt-2 mt-2">
                            <span>Total</span>
                            <span id="totalAmount">Rp 0</span>
                        </div>
                    </div>

                    <button type="submit" id="submitButton" class="w-full flex justify-center items-center py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300">
                        <span id="buttonText">Proses Pembayaran</span>
                        <!-- Spinner untuk loading state -->
                        <svg id="buttonSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </form>
            </div>

            <!-- Riwayat Transaksi -->
            <div class="lg:col-span-3 bg-white rounded-xl shadow-lg p-6 animate-fade-up" style="animation-delay: 300ms;">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <!-- Icon Dokumen (Lucide-react equivalent) -->
                        <svg class="w-6 h-6 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <h2 class="text-xl font-semibold text-gray-800">Riwayat Transaksi</h2>
                    </div>
                    <button id="clearHistoryBtn" class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors hidden">Hapus Riwayat</button>
                </div>
                <!-- Statistik transaksi -->
                <div class="grid sm:grid-cols-3 gap-4 mb-4">
                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600" id="totalTransactions">0</div>
                        <div class="text-sm text-gray-600">Transaksi</div>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="totalRevenue">Rp 0</div>
                        <div class="text-sm text-gray-600">Pendapatan</div>
                    </div>
                    <div class="text-center p-3 bg-purple-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600" id="avgTransaction">Rp 0</div>
                        <div class="text-sm text-gray-600">Rata-rata</div>
                    </div>
                </div>

                <!-- Tabel riwayat transaksi -->
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3">ID Transaksi</th>
                                <th scope="col" class="px-4 py-3">Pelanggan</th>
                                <th scope="col" class="px-4 py-3">Produk</th>
                                <th scope="col" class="px-4 py-3">Total</th>
                                <th scope="col" class="px-4 py-3">Metode</th>
                                <th scope="col" class="px-4 py-3">Waktu</th>
                            </tr>
                        </thead>
                        <tbody id="transactionList">
                            <!-- Riwayat transaksi akan dirender di sini oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pembayaran Berhasil -->
    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4 opacity-0 scale-95 transition-all duration-300 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full">
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <!-- Icon Centang (Lucide-react equivalent) -->
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Pembayaran Berhasil!</h3>
                <p class="text-gray-600">Transaksi Anda telah berhasil diproses.</p>
            </div>
            <div id="paymentDetails" class="bg-gray-50 rounded-lg p-4 mb-6 text-sm"></div>
            <button id="closeModalBtn" class="w-full py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">Tutup</button>
        </div>
    </div>
    
    <!-- Modal Konfirmasi Hapus Riwayat (Custom, menggantikan window.confirm) -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4 opacity-0 scale-95 transition-all duration-300 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <!-- Icon Peringatan (Lucide-react equivalent) -->
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.332 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Hapus Riwayat Transaksi?</h3>
            <p class="text-gray-600 mb-6">Anda yakin ingin menghapus semua riwayat transaksi? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex justify-end gap-3">
                <button id="cancelConfirmBtn" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors">Batal</button>
                <button id="confirmClearBtn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">Hapus</button>
            </div>
        </div>
    </div>

    <!-- Kontainer untuk Toast Notifications -->
    <div id="toastContainer" class="fixed bottom-5 right-5 z-50 space-y-3"></div>

    <!-- Template untuk baris transaksi baru di tabel -->
    <template id="transactionTemplate">
        <tr class="bg-white border-b hover:bg-gray-50">
            <td class="px-4 py-3 font-mono text-xs transaction-id"></td>
            <td class="px-4 py-3 font-medium transaction-customer"></td>
            <td class="px-4 py-3 text-gray-600 transaction-product"></td>
            <td class="px-4 py-3 font-semibold transaction-amount"></td>
            <td class="px-4 py-3"><span class="transaction-method px-2 py-1 rounded-full text-xs"></span></td>
            <td class="px-4 py-3 text-gray-500 transaction-time"></td>
        </tr>
    </template>
    
    <!-- Template untuk tampilan kosong di riwayat transaksi -->
    <template id="emptyStateTemplate">
        <tr>
            <td colspan="6" class="text-center py-10 text-gray-500">
                <!-- Icon Dokumen Kosong (Lucide-react equivalent) -->
                <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <p class="font-medium">Belum ada transaksi</p>
                <p class="text-sm">Silakan lakukan pembayaran pertama Anda.</p>
            </td>
        </tr>
    </template>

    <!-- Script JavaScript utama -->
    <script>
        // Memastikan DOM telah dimuat sepenuhnya sebelum menjalankan script
        document.addEventListener('DOMContentLoaded', function() {

            // ===== DATA & VARIABEL GLOBAL =====
            // Inisialisasi daftar transaksi, akan diisi dari localStorage
            let transactions = [];
            
            // Daftar kode promo yang tersedia
            const promoCodes = {
                "DISKON10": { type: "percentage", discount: 10, description: "Potongan 10%" },
                "HEMAT50K": { type: "fixed", discount: 50000, description: "Diskon tetap Rp 50.000" },
                "STUDENT20": { type: "percentage", discount: 20, description: "Diskon 20% khusus pelajar" }
            };

            // Mapping warna Tailwind CSS untuk metode pembayaran
            const paymentMethodColors = {
                'transfer': 'bg-blue-100 text-blue-800',
                'ewallet': 'bg-purple-100 text-purple-800',
                'credit': 'bg-orange-100 text-orange-800',
                'cash': 'bg-green-100 text-green-800'
            };

            // Mapping nama tampilan untuk metode pembayaran
            const paymentMethodNames = {
                'transfer': 'Transfer Bank',
                'ewallet': 'E-Wallet',
                'credit': 'Kartu Kredit',
                'cash': 'Bayar Tunai'
            };

            // Objek untuk menyimpan state aplikasi saat ini
            let appState = { currentDiscount: 0, appliedPromoCode: '' };

            // ===== MENDAPATKAN ELEMEN DOM =====
            const paymentForm = document.getElementById('paymentForm');
            const productSelect = document.getElementById('productSelect');
            const quantity = document.getElementById('quantity');
            const promoCodeInput = document.getElementById('promoCode');
            const applyPromoBtn = document.getElementById('applyPromoBtn');
            
            const subtotalEl = document.getElementById('subtotal');
            const discountEl = document.getElementById('discount');
            const discountRow = document.getElementById('discountRow');
            const totalAmountEl = document.getElementById('totalAmount');
            
            const transactionList = document.getElementById('transactionList');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            
            const totalTransactionsEl = document.getElementById('totalTransactions');
            const totalRevenueEl = document.getElementById('totalRevenue');
            const avgTransactionEl = document.getElementById('avgTransaction');
            
            const paymentModal = document.getElementById('paymentModal');
            const paymentDetails = document.getElementById('paymentDetails');
            const closeModalBtn = document.getElementById('closeModalBtn');

            const confirmModal = document.getElementById('confirmModal');
            const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
            const confirmClearBtn = document.getElementById('confirmClearBtn');

            const submitButton = document.getElementById('submitButton');
            const buttonText = document.getElementById('buttonText');
            const buttonSpinner = document.getElementById('buttonSpinner');
            
            const toastContainer = document.getElementById('toastContainer');

            // ===== FUNGSI UTILITY & UI =====

            /**
             * Memformat angka menjadi format mata uang Rupiah.
             * @param {number} amount - Jumlah yang akan diformat.
             * @returns {string} - String mata uang yang diformat.
             */
            const formatCurrency = amount => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);

            /**
             * Mendapatkan waktu saat ini dalam format HH:MM.
             * @returns {string} - Waktu saat ini.
             */
            const getCurrentTime = () => new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

            /**
             * Menghasilkan ID transaksi unik.
             * @returns {string} - ID transaksi.
             */
            const generateTransactionId = () => 'TRX-' + Date.now().toString().slice(-6);

            /**
             * Menampilkan notifikasi toast.
             * @param {string} message - Pesan yang akan ditampilkan.
             * @param {'success'|'error'} type - Tipe notifikasi (sukses atau error).
             */
            function showToast(message, type = 'success') {
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                const toast = document.createElement('div');
                toast.className = `w-auto px-6 py-3 rounded-lg shadow-lg text-white ${bgColor} animate-slide-in-down`;
                toast.textContent = message;
                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.classList.remove('animate-slide-in-down');
                    toast.classList.add('animate-fade-out'); // Tambahkan animasi keluar
                    toast.addEventListener('animationend', () => toast.remove()); // Hapus setelah animasi selesai
                }, 3000); // Tampilkan selama 3 detik
            }

            /**
             * Menampilkan atau menyembunyikan modal.
             * @param {HTMLElement} modalElement - Elemen modal yang akan diatur.
             * @param {boolean} show - True untuk menampilkan, false untuk menyembunyikan.
             */
            function toggleModal(modalElement, show) {
                if (show) {
                    modalElement.classList.add('modal-active'); // Menggunakan kelas yang di-style CSS
                } else {
                    modalElement.classList.remove('modal-active');
                }
            }

            // ===== FUNGSI PENYIMPANAN DATA (LOCALSTORAGE) =====

            /**
             * Memuat data transaksi dari localStorage.
             */
            function loadTransactions() {
                try {
                    const storedTransactions = localStorage.getItem('modernPaymentTransactions');
                    if (storedTransactions) {
                        transactions = JSON.parse(storedTransactions);
                    }
                } catch (error) {
                    console.error("Gagal memuat transaksi dari localStorage:", error);
                    transactions = []; // Reset jika ada error
                    showToast('Gagal memuat data transaksi. Data telah direset.', 'error');
                }
            }

            /**
             * Menyimpan data transaksi ke localStorage.
             */
            function saveTransactions() {
                try {
                    localStorage.setItem('modernPaymentTransactions', JSON.stringify(transactions));
                } catch (error) {
                    console.error("Gagal menyimpan transaksi ke localStorage:", error);
                    showToast('Gagal menyimpan data transaksi.', 'error');
                }
            }

            // ===== FUNGSI KALKULASI =====

            /**
             * Menghitung subtotal berdasarkan produk dan kuantitas yang dipilih.
             * @returns {number} - Nilai subtotal.
             */
            function calculateSubtotal() {
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                // Pastikan ada produk yang dipilih dan memiliki harga
                if (!selectedOption || !selectedOption.dataset.price) return 0;

                const price = parseInt(selectedOption.dataset.price, 10);
                const qty = parseInt(quantity.value, 10) || 1; // Default quantity 1
                return price * qty;
            }

            /**
             * Menghitung diskon berdasarkan subtotal dan data promo.
             * @param {number} subtotal - Nilai subtotal.
             * @param {object | null} promoData - Objek data promo atau null jika tidak ada.
             * @returns {number} - Nilai diskon yang dihitung.
             */
            function calculateDiscount(subtotal, promoData) {
                if (!promoData) return 0; // Tidak ada promo

                if (promoData.type === 'percentage') {
                    return Math.round(subtotal * promoData.discount / 100);
                } else if (promoData.type === 'fixed') {
                    return Math.min(promoData.discount, subtotal); // Diskon tidak boleh melebihi subtotal
                }
                return 0;
            }

            /**
             * Memperbarui tampilan subtotal, diskon, dan total pembayaran.
             */
            function updateTotal() {
                const subtotal = calculateSubtotal();
                const promoData = appState.appliedPromoCode ? promoCodes[appState.appliedPromoCode] : null;
                const discount = calculateDiscount(subtotal, promoData);
                const total = subtotal - discount;

                subtotalEl.textContent = formatCurrency(subtotal);
                if (discount > 0) {
                    discountEl.textContent = '-' + formatCurrency(discount);
                    discountRow.classList.remove('hidden');
                } else {
                    discountRow.classList.add('hidden');
                }
                totalAmountEl.textContent = formatCurrency(total);
                appState.currentDiscount = discount; // Simpan diskon saat ini di state
            }

            // ===== FUNGSI PROMO & TRANSAKSI =====

            /**
             * Menerapkan kode promo yang dimasukkan pengguna.
             */
            function applyPromoCode() {
                const code = promoCodeInput.value.trim().toUpperCase();
                
                if (!code) {
                    showToast('Masukkan kode promo!', 'error');
                    return;
                }

                if (!promoCodes[code]) {
                    showToast('Kode promo tidak valid!', 'error');
                    appState.appliedPromoCode = ''; // Hapus promo sebelumnya jika kode tidak valid
                    updateTotal();
                    return;
                }

                appState.appliedPromoCode = code; // Terapkan kode promo ke state
                updateTotal(); // Perbarui total
                showToast(`Promo "${code}" berhasil diterapkan: ${promoCodes[code].description}`);
            }

            /**
             * Mengatur ulang formulir pembayaran dan state aplikasi.
             */
            function resetFormState() {
                paymentForm.reset();
                appState = { currentDiscount: 0, appliedPromoCode: '' }; // Reset state diskon
                updateTotal(); // Perbarui total menjadi 0
            }

            // ===== RENDER & DOM MANIPULATION =====

            /**
             * Merender daftar transaksi ke tabel.
             */
            function renderTransactions() {
                transactionList.innerHTML = ''; // Hapus semua baris yang ada
                if (transactions.length === 0) {
                    // Tampilkan pesan "belum ada transaksi" jika daftar kosong
                    const emptyTemplate = document.getElementById('emptyStateTemplate');
                    transactionList.appendChild(emptyTemplate.content.cloneNode(true));
                    clearHistoryBtn.classList.add('hidden'); // Sembunyikan tombol hapus
                } else {
                    clearHistoryBtn.classList.remove('hidden'); // Tampilkan tombol hapus
                    // Render transaksi terbaru di atas
                    transactions.slice().reverse().forEach(transaction => {
                        const template = document.getElementById('transactionTemplate');
                        const clone = template.content.cloneNode(true);
                        const row = clone.querySelector('tr');

                        // Isi data transaksi ke dalam template
                        row.querySelector('.transaction-id').textContent = transaction.id;
                        row.querySelector('.transaction-customer').textContent = transaction.customerName;
                        row.querySelector('.transaction-product').textContent = `${transaction.product.split(' - ')[0]} (${transaction.quantity}x)`;
                        row.querySelector('.transaction-amount').textContent = formatCurrency(transaction.total);
                        
                        const methodEl = row.querySelector('.transaction-method');
                        methodEl.textContent = paymentMethodNames[transaction.paymentMethod];
                        // Tambahkan kelas warna berdasarkan metode pembayaran
                        methodEl.classList.add(paymentMethodColors[transaction.paymentMethod]);
                        
                        row.querySelector('.transaction-time').textContent = transaction.time;
                        
                        row.classList.add('animate-slide-in-down'); // Animasi masuk untuk baris baru
                        transactionList.appendChild(clone);
                    });
                }
                updateStatistics(); // Perbarui statistik setelah merender
            }
            
            /**
             * Memperbarui statistik total transaksi, pendapatan, dan rata-rata.
             */
            function updateStatistics() {
                const totalTrans = transactions.length;
                const totalRev = transactions.reduce((sum, t) => sum + t.total, 0);
                const avgTrans = totalTrans > 0 ? totalRev / totalTrans : 0; // Hindari pembagian nol

                totalTransactionsEl.textContent = totalTrans;
                totalRevenueEl.textContent = formatCurrency(totalRev);
                avgTransactionEl.textContent = formatCurrency(avgTrans);
            }
            
            // ===== MODAL LOGIC (Pembayaran Berhasil) =====

            /**
             * Menampilkan modal pembayaran berhasil dengan detail transaksi.
             * @param {object} transaction - Objek transaksi yang berhasil.
             */
            function showPaymentSuccessModal(transaction) {
                paymentDetails.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between"><span>ID Transaksi:</span><span class="font-medium font-mono text-xs">${transaction.id}</span></div>
                        <div class="flex justify-between"><span>Nama:</span><span class="font-medium">${transaction.customerName}</span></div>
                        <div class="flex justify-between"><span>Produk:</span><span class="font-medium">${transaction.product}</span></div>
                        <div class="flex justify-between"><span>Metode:</span><span class="font-medium">${paymentMethodNames[transaction.paymentMethod]}</span></div>
                        <div class="flex justify-between"><span>Total Bayar:</span><span class="font-bold text-green-600">${formatCurrency(transaction.total)}</span></div>
                        <div class="flex justify-between"><span>Waktu:</span><span class="font-medium">${transaction.time}</span></div>
                    </div>`;
                toggleModal(paymentModal, true);
            }
            
            /**
             * Menutup modal pembayaran berhasil.
             */
            function closePaymentSuccessModal() {
                toggleModal(paymentModal, false);
            }

            // ===== MODAL LOGIC (Konfirmasi Hapus Riwayat) =====

            /**
             * Menampilkan modal konfirmasi untuk menghapus riwayat transaksi.
             */
            function showClearHistoryConfirmModal() {
                toggleModal(confirmModal, true);
            }

            /**
             * Menutup modal konfirmasi hapus riwayat.
             */
            function closeClearHistoryConfirmModal() {
                toggleModal(confirmModal, false);
            }

            /**
             * Menghapus semua riwayat transaksi.
             */
            function clearAllTransactions() {
                transactions = []; // Kosongkan array transaksi
                saveTransactions(); // Simpan perubahan ke localStorage
                renderTransactions(); // Render ulang tabel (akan menampilkan empty state)
                showToast('Riwayat transaksi telah dihapus.', 'success');
                closeClearHistoryConfirmModal();
            }

            // ===== MAIN LOGIC & EVENT LISTENERS =====

            /**
             * Handler untuk pengiriman formulir pembayaran.
             * @param {Event} e - Objek event.
             */
            async function handlePaymentSubmit(e) {
                e.preventDefault(); // Mencegah refresh halaman
                
                const formData = new FormData(paymentForm);
                const selectedProductOption = productSelect.options[productSelect.selectedIndex];

                // Validasi input
                if (!selectedProductOption || !selectedProductOption.value) {
                    showToast('Pilih produk terlebih dahulu!', 'error');
                    return;
                }
                if (!formData.get('customerName').trim()) {
                    showToast('Nama pelanggan tidak boleh kosong!', 'error');
                    return;
                }
                if (!formData.get('customerEmail').trim()) {
                    showToast('Email pelanggan tidak boleh kosong!', 'error');
                    return;
                }
                if (!formData.get('paymentMethod')) {
                    showToast('Pilih metode pembayaran!', 'error');
                    return;
                }
                if (calculateSubtotal() <= 0) {
                    showToast('Jumlah pembayaran tidak valid. Pastikan produk dan kuantitas benar.', 'error');
                    return;
                }

                // Aktifkan loading state pada tombol
                buttonText.classList.add('hidden');
                buttonSpinner.classList.remove('hidden');
                submitButton.disabled = true;
                submitButton.classList.add('opacity-75', 'cursor-not-allowed');

                try {
                    // Simulasi delay jaringan/pemrosesan API
                    await new Promise(resolve => setTimeout(resolve, 1500)); // 1.5 detik delay

                    const transaction = {
                        id: generateTransactionId(),
                        customerName: formData.get('customerName'),
                        customerEmail: formData.get('customerEmail'),
                        product: selectedProductOption.textContent, // Teks lengkap produk (misal: "Paket Basic - Rp 50.000")
                        quantity: parseInt(formData.get('quantity'), 10),
                        paymentMethod: formData.get('paymentMethod'),
                        total: calculateSubtotal() - appState.currentDiscount,
                        time: getCurrentTime()
                    };

                    transactions.push(transaction); // Tambahkan transaksi baru
                    saveTransactions(); // Simpan ke localStorage
                    
                    showPaymentSuccessModal(transaction); // Tampilkan modal sukses
                    renderTransactions(); // Render ulang daftar transaksi
                    resetFormState(); // Reset formulir

                } catch (error) {
                    console.error("Error saat memproses pembayaran:", error);
                    showToast('Terjadi kesalahan saat memproses pembayaran. Coba lagi.', 'error');
                } finally {
                    // Nonaktifkan loading state pada tombol
                    buttonText.classList.remove('hidden');
                    buttonSpinner.classList.add('hidden');
                    submitButton.disabled = false;
                    submitButton.classList.remove('opacity-75', 'cursor-not-allowed');
                }
            }

            /**
             * Mengikat semua event listener ke elemen DOM.
             */
            function bindEventListeners() {
                // Event listener untuk perubahan produk atau kuantitas untuk memperbarui total
                ['change', 'input'].forEach(evt => {
                    productSelect.addEventListener(evt, updateTotal);
                    quantity.addEventListener(evt, updateTotal);
                });
                
                // Event listener untuk tombol 'Terapkan' promo
                applyPromoBtn.addEventListener('click', applyPromoCode);
                // Event listener untuk menekan 'Enter' di input promo
                promoCodeInput.addEventListener('keypress', e => { 
                    if (e.key === 'Enter') { 
                        e.preventDefault(); // Mencegah submit form jika input ada di dalam form
                        applyPromoCode(); 
                    }
                });
                
                // Event listener untuk submit formulir pembayaran
                paymentForm.addEventListener('submit', handlePaymentSubmit);

                // Event listener untuk tombol 'Tutup' pada modal pembayaran berhasil
                closeModalBtn.addEventListener('click', closePaymentSuccessModal);
                // Event listener untuk klik di luar area modal pembayaran berhasil (overlay)
                paymentModal.addEventListener('click', e => { 
                    if (e.target === paymentModal) closePaymentSuccessModal(); 
                });
                // Event listener untuk menekan tombol 'Escape' untuk menutup modal
                document.addEventListener('keydown', e => { 
                    if (e.key === 'Escape') {
                        closePaymentSuccessModal();
                        closeClearHistoryConfirmModal(); // Tutup juga modal konfirmasi
                    }
                });
                
                // Event listener untuk tombol 'Hapus Riwayat'
                clearHistoryBtn.addEventListener('click', showClearHistoryConfirmModal);

                // Event listener untuk tombol 'Batal' di modal konfirmasi
                cancelConfirmBtn.addEventListener('click', closeClearHistoryConfirmModal);
                // Event listener untuk tombol 'Hapus' di modal konfirmasi
                confirmClearBtn.addEventListener('click', clearAllTransactions);
            }

            /**
             * Fungsi inisialisasi aplikasi.
             */
            function init() {
                loadTransactions(); // Muat transaksi dari localStorage
                renderTransactions(); // Render tampilan transaksi
                updateTotal(); // Perbarui tampilan total awal
                bindEventListeners(); // Ikat semua event listener
                
                // Animasi elemen saat aplikasi dimuat
                document.querySelectorAll('.animate-fade-up').forEach((el, index) => {
                    el.style.animationDelay = `${100 * (index + 1)}ms`;
                    el.classList.add('opacity-100'); // Pastikan elemen terlihat setelah animasi
                });

                // Fokus pada input nama pelanggan saat halaman dimuat
                document.getElementById('customerName').focus();
            }

            // Panggil fungsi inisialisasi saat DOM siap
            init();
        });
    </script>
</body>
</html>
